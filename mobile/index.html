<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Unlock My Laptop</title>
  <meta name="theme-color" content="#0f172a" />
  <link rel="manifest" href="manifest.json" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #f1f5f9;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }
    .card {
      background: #1e293b;
      border-radius: 1.5rem;
      padding: 2.5rem;
      width: 100%;
      max-width: 360px;
      box-shadow: 0 25px 50px rgba(0,0,0,0.4);
      text-align: center;
    }
    h1 { font-size: 1.4rem; margin-bottom: 0.4rem; }
    .subtitle { color: #94a3b8; font-size: 0.9rem; margin-bottom: 2rem; }
    .fingerprint-btn {
      width: 120px; height: 120px;
      border-radius: 50%;
      border: 3px solid #3b82f6;
      background: #0f172a;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      margin: 0 auto 1.5rem;
      transition: all 0.2s;
      position: relative;
    }
    .fingerprint-btn:hover { border-color: #60a5fa; transform: scale(1.05); }
    .fingerprint-btn.scanning { border-color: #f59e0b; animation: pulse 1s infinite; }
    .fingerprint-btn.success { border-color: #22c55e; background: #052e16; }
    .fingerprint-btn.error { border-color: #ef4444; background: #1c0202; }
    .fingerprint-btn svg { width: 60px; height: 60px; }
    @keyframes pulse { 0%,100% { box-shadow: 0 0 0 0 rgba(59,130,246,0.4); } 50% { box-shadow: 0 0 0 20px rgba(59,130,246,0); } }
    .status {
      font-size: 0.95rem; color: #94a3b8;
      min-height: 2rem;
      transition: color 0.3s;
    }
    .status.success { color: #22c55e; }
    .status.error { color: #ef4444; }
    .status.scanning { color: #f59e0b; }
    .config-section {
      margin-top: 2rem;
      border-top: 1px solid #334155;
      padding-top: 1.5rem;
      text-align: left;
    }
    label { font-size: 0.8rem; color: #94a3b8; display: block; margin-bottom: 0.3rem; }
    input {
      width: 100%;
      background: #0f172a;
      border: 1px solid #334155;
      color: #f1f5f9;
      border-radius: 0.5rem;
      padding: 0.5rem 0.75rem;
      font-size: 0.85rem;
      margin-bottom: 0.75rem;
    }
    input:focus { outline: none; border-color: #3b82f6; }
    .save-btn {
      width: 100%;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 0.5rem;
      padding: 0.6rem;
      font-size: 0.9rem;
      cursor: pointer;
      font-weight: 500;
    }
    .save-btn:hover { background: #2563eb; }
    details summary { cursor: pointer; color: #64748b; font-size: 0.8rem; margin-top: 1.5rem; }
  </style>
</head>
<body>
<div class="card">
  <h1>üîì Laptop Unlock</h1>
  <p class="subtitle">Tap to authenticate with fingerprint</p>

  <button class="fingerprint-btn" id="unlockBtn" onclick="triggerUnlock()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <path d="M12 11c0 3.517-1.009 6.799-2.753 9.571m-3.44-2.04l.054-.09A13.916 13.916 0 008 11a4 4 0 118 0c0 1.017-.07 2.019-.203 3m-2.118 6.844A21.88 21.88 0 0015.171 17m3.839 1.132c.645-2.266.99-4.659.99-7.132A8 8 0 008 4.07M3 15.364c.64-1.319 1-2.8 1-4.364 0-1.457.39-2.823 1.07-4"/>
    </svg>
  </button>

  <p class="status" id="statusText">Tap to unlock your laptop</p>

  <details>
    <summary>‚öôÔ∏è Configure credentials</summary>
    <div class="config-section">
      <label>Server URL</label>
      <input type="url" id="serverUrl" placeholder="https://your-app.koyeb.app" />
      <label>Device ID</label>
      <input type="text" id="deviceId" placeholder="Paste your device ID" />
      <label>Secret Key</label>
      <input type="password" id="secretKey" placeholder="Paste your secret" />
      <button class="save-btn" onclick="saveConfig()">Save Configuration</button>
    </div>
  </details>
</div>

<script>
  // ‚îÄ‚îÄ‚îÄ Load saved config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const cfg = JSON.parse(localStorage.getItem("unlock-config") || "{}");
  if (cfg.serverUrl) document.getElementById("serverUrl").value = cfg.serverUrl;
  if (cfg.deviceId)  document.getElementById("deviceId").value  = cfg.deviceId;
  if (cfg.secretKey) document.getElementById("secretKey").value = cfg.secretKey;

  function saveConfig() {
    const config = {
      serverUrl: document.getElementById("serverUrl").value.trim().replace(/\/$/, ""),
      deviceId:  document.getElementById("deviceId").value.trim(),
      secretKey: document.getElementById("secretKey").value.trim(),
    };
    localStorage.setItem("unlock-config", JSON.stringify(config));
    setStatus("‚úÖ Configuration saved!", "success");
  }

  function setStatus(msg, type = "") {
    const el = document.getElementById("statusText");
    el.textContent = msg;
    el.className = "status " + type;
  }

  function setBtn(state) {
    const btn = document.getElementById("unlockBtn");
    btn.className = "fingerprint-btn " + state;
  }

  // ‚îÄ‚îÄ‚îÄ HMAC-SHA256 using Web Crypto API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function hmacSHA256(secret, message) {
    const enc = new TextEncoder();
    const key = await crypto.subtle.importKey(
      "raw", enc.encode(secret), { name: "HMAC", hash: "SHA-256" }, false, ["sign"]
    );
    const sig = await crypto.subtle.sign("HMAC", key, enc.encode(message));
    return Array.from(new Uint8Array(sig)).map(b => b.toString(16).padStart(2, "0")).join("");
  }

  // ‚îÄ‚îÄ‚îÄ Main unlock flow ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function triggerUnlock() {
    const config = JSON.parse(localStorage.getItem("unlock-config") || "{}");
    if (!config.serverUrl || !config.deviceId || !config.secretKey) {
      setStatus("‚ö†Ô∏è Please configure credentials first", "error");
      return;
    }

    setBtn("scanning");
    setStatus("üîç Verifying fingerprint...", "scanning");

    try {
      // Use WebAuthn / platform biometric (fingerprint/Face ID)
      const credential = await navigator.credentials.get({
        publicKey: {
          challenge: crypto.getRandomValues(new Uint8Array(32)),
          timeout: 30000,
          userVerification: "required",   // Forces biometric
          rpId: new URL(config.serverUrl).hostname,
        },
      }).catch(async () => {
        // Fallback: use navigator.credentials with password manager prompt
        // or just proceed with a local confirmation on devices without WebAuthn
        return await authenticateWithBiometricFallback();
      });

      if (!credential && credential !== "fallback") {
        throw new Error("Fingerprint authentication failed");
      }

      setStatus("üîê Sending unlock signal...", "scanning");

      // Sign the request
      const timestamp = Date.now();
      const signature = await hmacSHA256(
        config.secretKey,
        config.deviceId + timestamp
      );

      const resp = await fetch(`${config.serverUrl}/request-unlock`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ deviceId: config.deviceId, signature, timestamp }),
      });

      const result = await resp.json();
      if (!resp.ok) throw new Error(result.error || "Server error");

      setBtn("success");
      setStatus("‚úÖ " + result.message, "success");
      setTimeout(() => { setBtn(""); setStatus("Tap to unlock your laptop"); }, 4000);

    } catch (err) {
      setBtn("error");
      setStatus("‚ùå " + err.message, "error");
      setTimeout(() => { setBtn(""); setStatus("Tap to unlock your laptop"); }, 3000);
    }
  }

  // Fallback for devices that support biometrics but not WebAuthn
  async function authenticateWithBiometricFallback() {
    if ("PublicKeyCredential" in window && await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable()) {
      throw new Error("Biometric setup required ‚Äî see setup guide");
    }
    // On Android/iOS browsers, we can use a simple confirm as last resort
    const ok = confirm("Authenticate to unlock your laptop");
    if (!ok) throw new Error("Authentication cancelled");
    return "fallback";
  }
</script>
</body>
</html>
